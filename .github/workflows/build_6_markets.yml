name: Build 6 Markets DB (Manual Dispatch + Upload to Google Drive)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        market: [tw, us, cn, hk, jp, kr]

    env:
      MAX_WORKERS: "3"
      BATCH_SIZE: "200"

      # Google Drive secrets
      GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID_EMPTY }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check Drive env (safe)
        run: |
          echo "GDRIVE_FOLDER_ID is set? -> $([ -n "$GDRIVE_FOLDER_ID" ] && echo YES || echo NO)"
          echo "GDRIVE_SERVICE_ACCOUNT is set? -> $([ -n "$GDRIVE_SERVICE_ACCOUNT" ] && echo YES || echo NO)"
          echo "GDRIVE_FOLDER_ID length: ${#GDRIVE_FOLDER_ID}"
          echo "GDRIVE_SERVICE_ACCOUNT length: ${#GDRIVE_SERVICE_ACCOUNT}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy yfinance tqdm python-dotenv scipy requests lxml
            pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib
            pip install pykrx finance-datareader akshare
          fi

      - name: Ensure empty db (one-shot)
        run: |
          rm -f ${{ matrix.market }}_stock_warehouse.db
          echo "‚úÖ removed old local db: ${{ matrix.market }}_stock_warehouse.db"

      - name: Build DB (one market)
        run: |
          echo "üåç Build market: ${{ matrix.market }}"
          python -u main.py ${{ matrix.market }}

      - name: Upload DB artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: db-${{ matrix.market }}
          path: ${{ matrix.market }}_stock_warehouse.db
          retention-days: 90
