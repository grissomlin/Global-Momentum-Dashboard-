name: Only Feature Engineering (Parallel)

on:
  workflow_dispatch:
    inputs:
      market_mode:
        description: "æ¨¡å¼ï¼šå–®ä¸€ / å…¨éƒ¨ / è‡ªè¨‚å¤šåœ‹"
        required: true
        default: "single"
        type: choice
        options:
          - single
          - all
          - custom
      market:
        description: "å–®ä¸€å¸‚å ´ï¼ˆmarket_mode=single æ‰ç”¨ï¼‰"
        required: true
        default: "tw"
        type: choice
        options:
          - tw
          - us
          - cn
          - hk
          - jp
          - kr
      markets_csv:
        description: "è‡ªè¨‚å¤šåœ‹ï¼ˆmarket_mode=customï¼‰ï¼štw,us,jpï¼ˆé€—è™Ÿåˆ†éš”ï¼‰"
        required: false
        default: ""

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Build matrix JSON
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail

          MODE="${{ github.event.inputs.market_mode }}"
          SINGLE="${{ github.event.inputs.market }}"
          CSV_RAW="${{ github.event.inputs.markets_csv }}"

          # normalize
          CSV="$(echo "$CSV_RAW" | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]')"

          ALL='["tw","us","cn","hk","jp","kr"]'

          if [ "$MODE" = "all" ]; then
            MATRIX="$ALL"
          elif [ "$MODE" = "single" ]; then
            MATRIX="[\"$SINGLE\"]"
          elif [ "$MODE" = "custom" ]; then
            if [ -z "$CSV" ]; then
              echo "Custom mode requires markets_csv, e.g. tw,us,jp" >&2
              exit 2
            fi
            # convert "tw,us,jp" -> ["tw","us","jp"]
            MATRIX="[\"${CSV//,/\",\"}\"]"
          else
            echo "Unknown market_mode: $MODE" >&2
            exit 2
          fi

          echo "matrix=$MATRIX"
          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

  process:
    needs: prepare
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        market: ${{ fromJSON(needs.prepare.outputs.matrix) }}

    env:
      GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pandas numpy google-api-python-client google-auth-httplib2 google-auth-oauthlib python-dotenv

      # é€™å€‹ cache æ˜¯ã€Œæ¯å€‹ market å„è‡ªä¸€ä»½ã€ï¼Œä¸¦è¡Œæ™‚ä¸äº’æ¶
      - name: ğŸ’¾ Restore DB Cache (optional)
        uses: actions/cache@v4
        with:
          path: "*.db"
          key: db-cache-v3-${{ matrix.market }}
          restore-keys: |
            db-cache-v3-${{ matrix.market }}

      - name: ğŸ§ª Run Feature Engineering
        shell: bash
        run: |
          set -euo pipefail
          echo "ğŸ§ª Running market: ${{ matrix.market }}"
          python -u only_feature.py ${{ matrix.market }}

      # âœ… æ¯å€‹å¸‚å ´å„è§¸ç™¼ä¸€æ¬¡ï¼ˆä¸¦è¡Œ job å„è‡ªåŸ·è¡Œï¼‰
      - name: ğŸ“¢ Trigger Alpha Data Lab Sync (optional)
        if: success()
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        shell: bash
        run: |
          set -euo pipefail
          DB_NAME="${{ matrix.market }}_stock_warehouse"
          echo "ğŸš€ å¸‚å ´ ${{ matrix.market }} åŠ å·¥å®Œæˆï¼Œé€šçŸ¥ Alpha Data Lab..."
          curl -sS -X POST https://api.github.com/repos/grissomlin/Alpha-Data-Cleaning-Lab/dispatches \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: bearer $GH_PAT" \
            -d "{\"event_type\": \"warehouse_sync_complete\", \"client_payload\": {\"market_db\": \"$DB_NAME\"}}"
