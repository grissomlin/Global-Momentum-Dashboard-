name: Build 6 Markets DB (One-shot, Parallel + Upload to Google Drive)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
        market: [tw, us, cn, hk, jp, kr]

    env:
      MAX_WORKERS: "3"
      BATCH_SIZE: "200"

      # Google Drive secretsÔºà‰Ω†Ë¶ÅÂú® Repo Settings > Secrets and variables > Actions Ë®≠Â•ΩÔºâ
      # Ê≥®ÊÑèÔºöservice account ÈúÄË¶ÅÂ∞çË©≤ folder ÊúâÊ¨äÈôêÔºàfolder Ë¶Å share Áµ¶ service account emailÔºâ
      GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID_EMPTY }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Sanity check workflow files
        run: |
          echo "PWD=$(pwd)"
          ls -la .github || true
          ls -la .github/workflows || true
          echo "‚úÖ workflow file should be at .github/workflows/main.yml"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy yfinance tqdm python-dotenv scipy requests lxml
            pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib
            pip install pykrx finance-datareader akshare
          fi

      - name: Ensure empty db
        run: |
          rm -f ${{ matrix.market }}_stock_warehouse.db
          echo "‚úÖ removed old local db (if any): ${{ matrix.market }}_stock_warehouse.db"

      - name: Check Drive env (safe)
        run: |
          echo "GDRIVE_FOLDER_ID is set? -> $([ -n "$GDRIVE_FOLDER_ID" ] && echo YES || echo NO)"
          echo "GDRIVE_SERVICE_ACCOUNT is set? -> $([ -n "$GDRIVE_SERVICE_ACCOUNT" ] && echo YES || echo NO)"
          echo "GDRIVE_FOLDER_ID length: ${#GDRIVE_FOLDER_ID}"
          echo "GDRIVE_SERVICE_ACCOUNT length: ${#GDRIVE_SERVICE_ACCOUNT}"

      - name: Build DB (one market)
        run: |
          echo "üåç Build market: ${{ matrix.market }}"
          python -u main.py ${{ matrix.market }}

      - name: Inspect DB size and tables
        if: always()
        env:
          DB_PATH: ${{ matrix.market }}_stock_warehouse.db
        run: |
          DB="${DB_PATH}"
          if [ -f "$DB" ]; then
            echo "‚úÖ DB exists: $DB"
            ls -lh "$DB"
            python - << 'PY'
import os, sqlite3
db = os.environ["DB_PATH"]
conn = sqlite3.connect(db)
cur = conn.cursor()
tables = [r[0] for r in cur.execute("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name").fetchall()]
print("Tables:", tables)
for t in ["stock_prices","stock_info","stock_analysis","kbar_weekly","kbar_monthly","kbar_yearly","download_errors"]:
    try:
        n = cur.execute(f"SELECT COUNT(1) FROM {t}").fetchone()[0]
        print(f"{t}: {n:,}")
    except Exception as e:
        print(f"{t}: (missing) {e}")
conn.close()
PY
          else
            echo "‚ùå DB not found: $DB"
          fi

      - name: Upload DB artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: db-${{ matrix.market }}
          path: ${{ matrix.market }}_stock_warehouse.db
          retention-days: 90
