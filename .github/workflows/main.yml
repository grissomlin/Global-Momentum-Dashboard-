name: Build 6 Markets DB (One-shot, Parallel)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
        market: [tw, us, cn, hk, jp, kr]

    env:
      # âœ… ä¸€æ¬¡æ€§å»ºåº«ï¼Œé¿å…é¢¨æ§ï¼šå…ˆä¿å®ˆä¸€é»
      MAX_WORKERS: "3"
      BATCH_SIZE: "200"

      # âœ… é€™æ¬¡ä¸è¦æ”¾ GDRIVE_*ï¼Œé¿å…ä¸‹è¼‰èˆŠ DB è¦†è“‹
      # GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
      # GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy yfinance tqdm python-dotenv scipy requests lxml
            pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib
            pip install pykrx finance-datareader akshare
          fi

      - name: Ensure empty db
        run: |
          rm -f ${{ matrix.market }}_stock_warehouse.db

      - name: Build DB (one market)
        run: |
          echo "ğŸŒ Build market: ${{ matrix.market }}"
          python -u main.py ${{ matrix.market }}

      - name: Upload DB artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: db-${{ matrix.market }}
          path: ${{ matrix.market }}_stock_warehouse.db
          retention-days: 90
