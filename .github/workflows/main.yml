name: Build 6 Markets DB (One-shot, Parallel + Upload to Google Drive)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
        market: [tw, us, cn, hk, jp, kr]

    env:
      # âœ… ä¸€æ¬¡æ€§å»ºåº«ï¼šå…ˆä¿å®ˆä¸€é»é¿å…é¢¨æ§/å°é–
      MAX_WORKERS: "3"
      BATCH_SIZE: "200"

      # âœ… å•Ÿç”¨ Google Driveï¼ˆé‡é»ï¼‰
      # ç”¨ã€Œå…¨æ–°ç©ºè³‡æ–™å¤¾ã€é¿å…ä¸‹è¼‰èˆŠ DB è¦†è“‹æœ¬åœ° one-shot DB
      GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID_EMPTY }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy yfinance tqdm python-dotenv scipy requests lxml
            pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib
            pip install pykrx finance-datareader akshare
          fi

      # âœ… one-shotï¼šæ¯æ¬¡ job éƒ½å¾ç©º DB é–‹å§‹
      - name: Ensure empty db
        run: |
          rm -f ${{ matrix.market }}_stock_warehouse.db
          echo "âœ… removed old local db (if any): ${{ matrix.market }}_stock_warehouse.db"

      # ï¼ˆå¯é¸ï¼‰é¡¯ç¤ºç’°å¢ƒè®Šæ•¸æ˜¯å¦æœ‰æ³¨å…¥ï¼ˆä¸è¦å° secrets å…§å®¹ï¼‰
      - name: Check Drive env (safe)
        run: |
          echo "GDRIVE_FOLDER_ID is set? -> $([ -n "$GDRIVE_FOLDER_ID" ] && echo YES || echo NO)"
          echo "GDRIVE_SERVICE_ACCOUNT is set? -> $([ -n "$GDRIVE_SERVICE_ACCOUNT" ] && echo YES || echo NO)"

      - name: Build DB (one market)
        run: |
          echo "ğŸŒ Build market: ${{ matrix.market }}"
          python -u main.py ${{ matrix.market }}

      # ï¼ˆå¯é¸ï¼‰æª¢æŸ¥ DB æ˜¯å¦çœŸçš„é•·å¤§ + è¡¨æ•¸é‡
      - name: Inspect DB size and tables
        if: always()
        run: |
          DB="${{ matrix.market }}_stock_warehouse.db"
          if [ -f "$DB" ]; then
            echo "âœ… DB exists: $DB"
            ls -lh "$DB"
            python - << 'PY'
import os, sqlite3, sys
db = os.environ.get("DB_PATH")
if not db:
    db = sys.argv[1] if len(sys.argv)>1 else None
if not db or not os.path.exists(db):
    print("DB not found")
    raise SystemExit(0)
conn = sqlite3.connect(db)
cur = conn.cursor()
tables = cur.execute("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name").fetchall()
print("Tables:", [t[0] for t in tables])
for t in ["stock_prices","stock_info","stock_analysis","kbar_weekly","kbar_monthly","kbar_yearly","download_errors"]:
    try:
        n = cur.execute(f"SELECT COUNT(1) FROM {t}").fetchone()[0]
        print(f"{t}: {n:,}")
    except Exception as e:
        print(f"{t}: (missing) {e}")
conn.close()
PY
          else
            echo "âŒ DB not found: $DB"
          fi
        env:
          DB_PATH: ${{ matrix.market }}_stock_warehouse.db

      - name: Upload DB artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: db-${{ matrix.market }}
          path: ${{ matrix.market }}_stock_warehouse.db
          retention-days: 90
